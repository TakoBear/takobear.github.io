<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>[OpenSource] 更新ffmpeg 2.1 for iOS,  Xcode 5.1 與OS X 10.9.2</title>
  <meta name="description" content="其實這兩天Bear更新了Xcode 5.1以後, 發現一些悲劇...其中一點就是發現可惡的Xcode 5.1竟然不能再用gcc來編譯了...而是要改成用clang來編譯當Bear把ffmpeg刪除準備要重新安裝時...就發現可恨的build failed的錯誤了...為了解決這問題... Bear也花了點時間研究...">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/blog.css">
  <link rel="stylesheet" href="/css/paginate.css">
  <link rel="canonical" href="http://www.takobear.tw/2014/03/22/opensource-ffmpeg-2-1-for-ios-xcode-5-1-os-x-10-9-2/">
  <link rel="alternate" type="application/rss+xml" title="TAKOBEAR" href="http://www.takobear.tw/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">TAKOBEAR</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
          <a class="page-link" href="/categories/">
            <i class="fa fa-tags"></i> 分類
          </a>

          <a class="page-link" href="/feed.xml">
            <i class="fa fa-rss-square"></i> RSS
          </a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">[OpenSource] 更新ffmpeg 2.1 for iOS,  Xcode 5.1 與OS X 10.9.2</h1>
    <p class="post-meta"><time datetime="2014-03-22T21:13:02+08:00" itemprop="datePublished">Mar 22, 2014</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/3810771_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">其實這兩天Bear更新了Xcode 5.1以後, 發現一些悲劇...
其中一點就是發現可惡的Xcode 5.1竟然不能再用gcc來編譯了...而是要改成用clang來編譯
當Bear把ffmpeg刪除準備要重新安裝時...就發現可恨的build failed的錯誤了...
為了解決這問題... Bear也花了點時間研究, 總算有點成果了!!! 大家先來看看吧!</div>
<div><!--BLOG_SUMMARY_END--></div>
<div>
<div id="190299934830020479" class="wcustomhtml" align="left"><script async="">// < ![CDATA[

// ]]></script><!-- takobear 336*280 --><ins class="adsbygoogle" data-ad-client="ca-pub-2505331387846610" data-ad-slot="8029204281"></ins><script>// < ![CDATA[
 (adsbygoogle = window.adsbygoogle || []).push({});
// ]]></script><script async="">// < ![CDATA[

// ]]></script><!-- takobear 336*280 --><ins class="adsbygoogle" data-ad-client="ca-pub-2505331387846610" data-ad-slot="8029204281"></ins><script>// < ![CDATA[
 (adsbygoogle = window.adsbygoogle || []).push({});
// ]]></script></div>
</div>
<div class="paragraph"><a title="" href="https://github.com/TakoBear/ffmpeg-iOS-7-Install-Script-Xcode-5.1" target="_blank">點選github下載連結</a>其實這包script最早的出處是來自於此處 (<a title="" href="http://www.cnblogs.com/wyymaomi/p/3603643.html" target="_blank">原始教學出處</a>)
但是Bear下載以後發現這包程式碼在某些情況中問題還蠻多的...
下載以後做了ㄧ些調整, 我們先來看看使用前, 你需要有哪些步驟呢?

首先打開你的Xcode , 確認版本是在5.1以上 (如果你的手機是iOS 7.1, 那你理論上應該是Xcode 5.1)
打開以後, 按下Command + , 鍵
之後看到以下畫面

</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/2125298_orig.jpg" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">確認好Xcode的版本是正確的以後, 這邊開始Bear要提醒幾個重要的轉折變化,
過去的教學文章中, 會提到Xcode的編譯器所在位置在這個路徑:
<span style="color: #eb0b0b;">/Applications/Xcode.app/Contents//Developer/Platforms/iPhoneSimulator.platform/Developer/usr/bin/gcc</span>但是很不幸的, 這次的Xcode 5.1的變動中, 編譯器的位置已經路徑被換了, 也不再使用gcc編譯,
新版的編譯器路徑在這裡:
<span style="color: #fb0b0b;"><strong>/Applications/XCode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang</strong></span>
改成以clang為編譯器的方式, 因為這以前在Xcode 4.6的編譯方法從這時候開始就再也不能用了....
為了解決這煩惱, 許多網友寫了一些新的一鍵安裝腳本(script)

</div>
<div>
<div id="818723290837663659" class="wcustomhtml" align="left"><script>// < ![CDATA[

// ]]></script></div>
</div>
<div class="paragraph">這個script在使用的時候有幾點要特別注意,
過去Bear在 <a title="" href="http://www.takobear.weebly.com/12/post/2013/07/ffmpeg-ios-61.html" target="_blank">ffmpeg 與iOS 6.1</a>一文中, 所採用的方法是只有編譯i386
也就是只有模擬器的方式, 這次的script中做了一些比較大的變動
其中一點就是編譯的架構同時包含了armv7 與armv7s 以及i386
換言之, 這次編譯好的ffmpeg library, 可以放在模擬器上或是手機上跑都是沒問題的!!!可以想像一下, 如果接下來一陣子蘋果沒有更換編譯器的位置路徑的話,
這個script有幾個很方便的地方

</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/2277706_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">如果你只是想要改ffmpeg的版本以及iOS的版本,
只需要在腳本的最上方做設定, VERSION代表的是ffmpeg你要下載安裝的版本
而SDKVERSION代表的是iOS SDK的版本</div>
<div>
<div class="wsite-image wsite-image-border-none"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/435041_orig.jpg" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">因為要編譯3個不同的架構, 從一開始的編譯上會有一些設定的不同
針對不同的平台中, 我們的configure設定內容會有所不同
之前原本在<a title="" href="http://www.takobear.weebly.com/12/post/2013/07/ffmpeg-ios-61.html" target="_blank">ffmpeg</a>的教學文中所提到的設定, 理論上這邊都可以涵蓋的到如果大家之後有要編譯libx264之類的, 只要到這一段程式碼進行修改就行了

不過大家要注意一點, 這邊編譯出來的資料夾是連接到一個叫做dependencies的資料夾內
如果大家之後要用到像是libx264之類的函式庫,
是有必要先把檔案放到這個資料夾內的, 或是大家就要在修改這邊的configure內容後再編譯才行喔!

最後編譯完成以後, 會再把三個不同架構的.a檔案, 利用libp這個命令來把它們整合在一起
也就是以下這段程式碼

</div>
<div>
<div class="wsite-image wsite-image-border-none"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/8258026_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">這邊說了這些, 那還要注意一些問題,
原始教學出處中所提到的gas script
在某些情況下似乎會有版本的指定問題, 如果大家原本的/usr/local/bin資料夾內
是已經有gas-preprocessor.pl這個檔案的話, 是會有一些狀況的, 也因此Bear才做了些調整如下</div>
<div>
<div id="673218802191391695" class="wcustomhtml" align="left"><script>// < ![CDATA[

// ]]></script></div>
</div>
<div class="paragraph">就是這麼簡單就能運作了!!!
原版的教學中, Bear只有針對i386做調整, 新版的script已經可以把它整個打包起來變成一個新的package給不同架構使用
讓我們看看script執行的結果吧!!</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/6780877_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">到build-&gt;built內後, 就能看到以下的打包結果了</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/176860_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">點選Universal的部分, 就能看到include的路徑以及lib的資料夾
include的路徑就是在Xcode內所要指定的Header Path
lib的路徑則是Library Path,
以一個新專案為例, 大家可以採用以下步驟, 這邊Bear先建立一個新專案名為FFmepgDemo_2014</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/754474_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">先把universal的資料夾整個拖曳過去</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/6113196_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">建議大家要把Copy items into destination group's folder (if needed)給勾選起來
這樣專案的管理上之後是有好處的!
接下來請大家到Build Setting的部分,
我們要修改兩個Path路徑好讓Compiler在編譯的時候能正確地連結到function</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/5741275_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/1176973_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">做法也相當簡單, 把universal的include資料夾給拖曳到 Header Search Path內就行了
(注意請找到在FFmpegDemo_2014的資料夾, 我們希望連接的Header Path是你剛剛copy進專案的標頭檔)另外就是重複一樣的步驟對Library Search Paths,
基本上要確認的就是
Header Search Paths內要有一欄 <span style="color: #f40c0c;">$(PROJCET_DIR)/FFmpegDemo_2014/universal/include</span>的路徑
Library Search Paths 內要有<span style="color: #f80505;">$(PROJCET_DIR)/FFmpegDemo_2014/universal/lib</span>的路徑


確認這兩點以後呢, 還有幾點要做, 請先到
Build Phases內, Link with Binaries的部分加上一個Library: <span style="color: #f00e0e;">libz1.2.5 </span>

</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/1092678_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">如果沒有的話, 編譯的時候會有以下的錯誤畫面喔!!</div>
<div>
<div class="wsite-image wsite-image-border-thin"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/1706_orig.png" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">這邊需要注意一下, Bear為了使教學能夠簡潔
所使用的Sample Code是修改自以前的專案內容: <a href="http://www.takobear.weebly.com/12/post/2013/09/bear-audiotoolboxffmpeg-part-end.html" target="_blank">如何利用ffmpeg製作iOS 廣播電台</a>不過, 即使完成這些步驟後, 還是不行的噢!!!
因為Xcode 5.1預設編譯的時候會打開arm64, 以64位元方式編譯
但是因為我們編譯的項目只包含了armv7, armv7s, i386
假如你使用了iPhone 5s編譯的話, 編譯器是會報錯的噢!!
為了避免這種問題, 在Build Settings的項目中也要有對應的修改如下圖

</div>
<div>
<div class="wsite-image wsite-image-border-none"><a><img src="http://www.takobear.weebly.com/uploads/1/9/9/7/19975491/5115718_orig.jpg" alt="图片" /></a>
<div></div>
</div>
</div>
<div class="paragraph">確認好以後, 就能夠正確的編譯囉!!!!Bear再簡單總整理一下, 一個ffmpeg的專案內, 大家需要確保有以下幾項內容:
1. library 的.a檔案有沒有在專案內 (不在專案內的話, 請確認在Build Settings的Library Search Paths有沒有正確指定到位置)
2. include的檔案有沒有在專案內 (不在專案內的話, 請確認在Build Settings的Header Search Paths有沒有正確指定到位置)
3. 確認專案內有沒有包含libz1.2.5.dylib
4. 確認Build Settings 的Build Active Architecture Only是NO 以及Valid Architectures有沒有不被包含的架構(例如arm64)

確認有以下四點以後, 基本上就是沒問題的了!!!!

最後我們在來討論一些常見的ffmpeg編譯錯誤該如何解決:

1. cputype (12) does not match previous archive members cputype (7)(all members must match)
通常是指沒有在clean build後的編譯發生的問題, 可以<a title="" href="http://www.xcoder.cn/html/mobile/iOS/2013/0307/1604.html" target="_blank">參考此篇解決</a>

2. armv7, armv7s 確認./configure有加上這兩項目
<strong>--disable-armv6 \</strong>
<strong>--disable-armv6t2 \</strong>

3. ERROR: .endm without .macro at /usr/sbin/gas_preprocessor.pl
<span style="color: #333333;">這個錯誤比較棘手, Bear被這問題煩了好幾天</span>
<span style="color: #333333;">一般來說是出現在你的系統內有兩個以上的gas_preprocessor.pl檔案</span>
<span style="color: #333333;">這邊在測試的時候, 請注意看一下install-ffmpeg.sh檔案, 裡面的是針對</span>
/usr/local/bin/gas-preprocessor.pl 這個檔案進行操作
如果有遇到的話, 理論上只要下載本次教學中的git後執行就不會有問題了

4. 這次的install-ffmpeg中有限制iOS版本在 -miphoneos-version-min=$<span style="color: #9555c2;">{SDKVERSION}</span>
以這次的script中, Bear已經限制了只能在iOS 7.1的版本, 有需要調整的人只要把這一行給拿掉後在做相關測試就好

5. ffmpeg執行時遇到相關問題的話, 把./configure的--disable-debug 改為 --enable-debug --disable-stripping即可。
由於開啟debug後的檔案會相差很大, 根據網友經驗相差會有約7倍大小的差異, 請大家自行注意


參考資料: <a title="" href="http://albert-oma.blogspot.tw/2013/01/ffmpeg-library-for-ios.html" target="_blank">Albert</a>, <a title="" href="http://www.cnblogs.com/smileEvday/p/ffmpeg.html" target="_blank">CNBlogs</a>(1), <a title="" href="http://www.cnblogs.com/wyymaomi/p/3603643.html" target="_blank">CNBlogs</a>(2), <a title="" href="http://www.takobear.weebly.com/12/post/2013/09/bear-audiotoolboxffmpeg-part-end.html" target="_blank">Bear實驗室: ffmpeg廣播電台</a>


本次專案下載位置:
<a title="" href="https://github.com/TakoBear/ffmpeg-iOS-7-Install-Script-Xcode-5.1.git" target="_blank">https://github.com/TakoBear/ffmpeg-iOS-7-Install-Script-Xcode-5.1.git</a>

注意因為編譯出來的libavcodec.a檔案太大, 我們無法上傳到github上面
請大家就....自己試試看玩玩看吧XDDDD

喜歡這篇文章嗎? 趕快加入Takobear粉絲團吧!

</div>
<div></div>

  </div>

</article>


<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        this.page.url = "http:\/\/www.takobear.tw\/2014\/03\/22\/opensource-ffmpeg-2-1-for-ios-xcode-5-1-os-x-10-9-2\/";
        this.page.identifier = "395 http:\/\/www.takobear.tw\/201702608526356260322804024687\/opensource-ffmpeg-21-for-ios-xcode-51-os-x-1092";
    };

    (function() {
        var d = document, s = d.createElement('script');

        s.src = '//takobear.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-2">
        <ul class="contact-list">
          <li>TAKOBEAR</li>
          <li><a href="mailto:takobearx@gmail.com">takobearx@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-1 footer-col-right">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/TakoBear">
  <span class="icon"><i class="fa fa-github fa-fw"></i></span>
  <span class="username">TakoBear</span>
</a>

          </li>
          

          
          <li>
            <a href="https://www.facebook.com/funnytechandnews">
  <span class="icon"><i class="fa fa-facebook fa-fw"></i></span>
  <span class="username">funnytechandnews</span>
</a>

          </li>
          
        </ul>
      </div>
    </div>

    <div class="footer-license">
      2013-2016 TakoBear. All rights reserved.
    </div>
  </div>

</footer>


  </body>

</html>
